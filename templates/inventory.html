{% extends "base.html" %}

{% block head_extra %}
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/inventory.css') }}">
{% endblock %}

{% block title %}Inventory - IMS{% endblock %}
{% block content %}


    <div class="container">
        <h2 class="page-title">Inventory Purchase Entry</h2>
        
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}

        <form method="POST" action="{{ url_for('inventory.inventory') }}" class="stock-deliveries-form">
            <!-- Row 1 -->
            <legend>Bill Details</legend>
            <div class="form-row">
                <div class="field">
                    <label for="BillDate">Bill Date</label>
                    <input type="date" id="BillDate" name="BillDate" required>
                </div>
                <div class="field">
                    <label for = "BillNo">Bill No</label>
                    <input type="text" id="BillNo" name="BillNo" required>
                </div>

                <div class="field">
                    <label for = DeliveryDate>Delivery Date</label>
                    <input type="date" id="DeliveryDate" name="DeliveryDate" required>
                </div>

                <div class="field field-wide">
                    <label for = "Agency">Agency</label>
                <select id="Agency" name="Agency" class="agency-select">
                    <option value="">--Select--</option>
                    {% for name in agency_list %}
                      <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
                </div>

                
            </div>
            
            <!-- Row 2 -->
            <div class="form-row">
                <div class="field">
                    <label for="BillAmount">Bill Amount</label>
                    <input type="number" step="0.01" id="BillAmount" name="BillAmount" min="0" required>
                </div>

                <div class="field">
                    <label for="TaxAmount">Tax Amount</label>
                    <input type="number" step="0.01" id="TaxAmount" name="TaxAmount" min="0" required>
                </div>

                <div class="field">
                    <label for = "DiscountInBill">Disc</label>
                    <select id="DiscountInBill" name="DiscountInBill" required>
                        <option value="">--Select--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="field">
                    <label for="Disc_amount">Disc Amount</label>
                    <input type="number" step="0.01" id="Disc_amount" name="Disc_amount" min="0" required>
                </div>

                <div class="field">
                    <label for="BillTotal">Bill Total <span style="font-size: 12px; color: #6c757d;">(Auto-calculated)</span></label>
                    <input type="number" step="0.01" id="BillTotal" name="BillTotal" min="0" readonly>
                </div>

                
            </div>

            <!-- Items Entry Section -->
            <legend>Items in Bill</legend>
            <div class="form-row items-entry-row">
                <div class="field">
                    <label for="ItemName">Item Name</label>
                    <select id="ItemName" name="item-select" class="item-select">
                        <option value="">--Select Item--</option>
                        {% for name in med_list %}
                            <option value="{{ name }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="field">
                    <label for="Quantity">Quantity</label>
                    <input type="number" id="Quantity" name="new-quantity" min="1">
                </div>
                <div class="field">
                    <label for="BatchNo">Batch No</label>
                    <input type="text" id="BatchNo" name="new-batch_no">
                </div>
                <div class="field">
                    <label for="ExpiryDate">Expiry Date</label>
                    <input type="month" id="ExpiryDate" name="new-expiry_date">
                </div>
                <div class="field">
                    <label for="Price">Price</label>
                    <input type="number" step="0.01" id="Price" name="new-price">
                </div>
            </div>

            <div class="actions">
                <button type="button" onclick="addItem()">Add Another Item</button>
                <button type="button" onclick="openNewMedicineModal()" class="btn-add-medicine">Add New Medicine</button>
                <button type="button" onclick="openUpdatePriceModal()" class="btn-update-price">Update Price</button>
            </div>

            <div id="item-details" class="item-details"></div>
        
            <!-- Items Table -->
            <div class="table-container">
                <table class="data-table" id="items-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Batch No</th>
                            <th>Expiry Date</th>
                            <th>Price</th>
                            <th>Price Diff</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="items-list">
                        <!-- Rows will be added here -->
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <input type="submit" value="Save Purchase" onclick="debugFormSubmission(event)">
            </div>
        </form>
    </div>

    <!-- Add New Medicine Modal -->
    <div id="newMedicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Medicine</h3>
                <span class="close" onclick="closeNewMedicineModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="newMedicineForm">
                    <div class="modal-form-row">
                        <div class="modal-field">
                            <label for="newMedicineName">Medicine Name *</label>
                            <input type="text" id="newMedicineName" name="MName" required>
                        </div>
                        <div class="modal-field">
                            <label for="newMedicineCompany">Company</label>
                            <input type="text" id="newMedicineCompany" name="MCompany">
                        </div>
                    </div>
                    <div class="modal-form-row">
                        <div class="modal-field">
                            <label for="newMedicineType">Type *</label>
                            <select id="newMedicineType" name="Mtype" required>
                                <option value="">--Select Type--</option>
                                <!-- Options will be populated dynamically from database -->
                            </select>
                        </div>
                        <div class="modal-field">
                            <label for="newMedicineMRP">MRP</label>
                            <input type="number" step="0.01" id="newMedicineMRP" name="MRP" min="0">
                        </div>
                    </div>
                    <div class="modal-form-row">
                        <div class="modal-field">
                            <label for="newMedicineGST">GST %</label>
                            <input type="number" step="0.01" id="newMedicineGST" name="GST" min="0" max="100">
                        </div>
                        <div class="modal-field">
                            <label for="newMedicineHSN">HSN Code</label>
                            <input type="text" id="newMedicineHSN" name="HSN">
                        </div>
                    </div>
                    <div class="modal-form-row">
                        <div class="modal-field">
                            <label for="newMedicinePTR">PTR</label>
                            <input type="number" step="0.01" id="newMedicinePTR" name="PTR" min="0">
                        </div>
                        <div class="modal-field">
                            <label for="newMedicineWeight">Weight/Pack Size</label>
                            <input type="text" id="newMedicineWeight" name="Weight" placeholder="e.g., 10mg, 100ml">
                        </div>
                    </div>
                    <div class="modal-form-row">
                        <div class="modal-field">
                            <label for="newMedicineOffer1">Offer 1</label>
                            <input type="text" id="newMedicineOffer1" name="Offer1" placeholder="e.g., Buy 2 Get 1">
                        </div>
                        <div class="modal-field">
                            <label for="newMedicineOffer2">Offer 2</label>
                            <input type="text" id="newMedicineOffer2" name="Offer2" placeholder="e.g., 10% Off">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeNewMedicineModal()" class="btn-cancel">Cancel</button>
                <button type="button" onclick="saveNewMedicine()" class="btn-save">Save Medicine</button>
            </div>
        </div>
    </div>

    <!-- Update Price Modal -->
    <div id="updatePriceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Medicine Price</h3>
                <span class="close" onclick="closeUpdatePriceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('inventory.update_price') }}" id="updatePriceForm">
                    <div class="modal-form-row">
                        <div class="modal-field">
                            <label for="updateMedicineName">Medicine Name *</label>
                            <select id="updateMedicineName" name="medicine_name" required onchange="loadMedicineDetails(this.value)">
                                <option value="">--Select Medicine--</option>
                                {% for name in med_list %}
                                    <option value="{{ name }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Current Values Display -->
                    <div class="current-values-section" id="currentValuesSection" style="display: none;">
                        <h4>Current Values</h4>
                        <div class="modal-form-row">
                            <div class="modal-field">
                                <label>Current MRP</label>
                                <input type="text" id="currentMRP" readonly>
                            </div>
                            <div class="modal-field">
                                <label>Current PTR</label>
                                <input type="text" id="currentPTR" readonly>
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div class="modal-field">
                                <label>Current HSN</label>
                                <input type="text" id="currentHSN" readonly>
                            </div>
                            <div class="modal-field">
                                <label>Current GST %</label>
                                <input type="text" id="currentGST" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Values Input -->
                    <div class="new-values-section" id="newValuesSection" style="display: none;">
                        <h4>New Values</h4>
                        <div class="modal-form-row">
                            <div class="modal-field">
                                <label for="newMRP">New MRP *</label>
                                <input type="number" step="0.01" id="newMRP" name="new_mrp" min="0" required>
                            </div>
                            <div class="modal-field">
                                <label for="newPTR">New PTR</label>
                                <input type="number" step="0.01" id="newPTR" name="new_ptr" min="0">
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div class="modal-field">
                                <label for="newHSN">New HSN Code</label>
                                <input type="text" id="newHSN" name="new_hsn">
                            </div>
                            <div class="modal-field">
                                <label for="newGST">New GST %</label>
                                <input type="number" step="0.01" id="newGST" name="new_gst" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields to store old values for logging -->
                    <input type="hidden" id="oldMRP" name="old_mrp">
                    <input type="hidden" id="oldPTR" name="old_ptr">
                    <input type="hidden" id="oldHSN" name="old_hsn">
                    <input type="hidden" id="oldGST" name="old_gst">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeUpdatePriceModal()" class="btn-cancel">Cancel</button>
                <button type="button" onclick="submitPriceUpdate()" class="btn-save" id="updatePriceBtn" style="display: none;">Update Price</button>
            </div>
        </div>
    </div>



      



<!-- jQuery & Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
var currentMRP = null;
  // When item name changes, fetch Quantity and MRP
$(document).ready(function() {
  // Initialize Select2
  $('.agency-select').select2({
    placeholder: "--Select Item--",
    allowClear: true,
    width: 'resolve'
  })
});
  
$(document).ready(function() {
  // Initialize Select2
  $('.item-select').select2({
    placeholder: "--Select Item--",
    allowClear: true,
    width: 'resolve'
  });
    
    $('.item-select').on('change', function() {
      var $select = $(this);
      var itemName = $select.val();
      var $row = $select.closest('tr');
      var $detailsDiv = $('#item-details');
      if (itemName) {
        $.get('/api/medicine-details', {name: itemName}, function(data) {
          // First row: Weight, MRP, GST, Offer1+Offer2
          let offer = '';
          if (data.Offer1 && data.Offer2) offer = data.Offer1 + '+' + data.Offer2;
          else if (data.Offer1) offer = data.Offer1 + "-NoOffer";
          else if (data.Offer2) offer = data.Offer2 + "-Check";

          let row1 = '';
          if (data.Weight) row1 += `Weight: ${data.Weight}&emsp;`;
          if (data.MRP) {
            row1 += `MRP: ${data.MRP}&emsp;`;
            currentMRP = parseFloat(data.MRP);
          } else {
            currentMRP = null;
          };
          if (data.GST) row1 += `GST: ${data.GST}&emsp;`;
          if (offer) row1 += `Offer: ${offer}&emsp;`;

          // Second row: Company, Type, HSN, PTR
          let row2 = '';
          if (data.MCompany) row2 += `Company: ${data.MCompany}&emsp;`;
          if (data.Mtype) row2 += `Type: ${data.Mtype}&emsp;`;
          if (data.HSN) row2 += `HSN: ${data.HSN}&emsp; `;
          if (data.PTR) row2 += `PTR: ${data.PTR}&emsp; `;

          $detailsDiv.html(
            `<div class="item-details-row">${row1.trim()}</div>
            <div class="item-details-row">${row2.trim()}</div>`
          );
        });
      } else {
        $detailsDiv.html('');
      }
    });
  });

  
function addItem() {
  // Get values from the form
  var itemName = document.getElementById('ItemName');
  var itemNameText = itemName.options[itemName.selectedIndex].text;
  var quantity = document.getElementById('Quantity').value;
  var batchNo = document.getElementById('BatchNo').value;
  var expiryDate = document.getElementById('ExpiryDate').value;
  var price = document.getElementById('Price').value;

  // Calculate difference
  var difference = 0;
  if (currentMRP !== null && price) {
    difference = (parseFloat(price) - currentMRP).toFixed(2);
  }

  if (!itemName.value || !quantity || !batchNo || !expiryDate || !price) {
    alert('Please fill all item fields.');
    return;
  }

  // Add row to table
  var table = document.getElementById('items-list');
  var row = table.insertRow();
  row.innerHTML = `
    <td><input type="hidden" name="item_name" value="${itemName.value}">${itemNameText}</td>
    <td><input type="hidden" name="quantity" value="${quantity}">${quantity}</td>
    <td><input type="hidden" name="batch_no" value="${batchNo}">${batchNo}</td>
    <td><input type="hidden" name="expiry_date" value="${expiryDate}">${expiryDate}</td>
    <td><input type="hidden" name="price" value="${price}">${price}</td>
    <td><input type="hidden" name="difference" value="${difference}">${difference}</td>
    <td><button type="button" class="remove-item-btn" onclick="removeRow(this)">×</button></td>
  `;

  // DEBUG: Check if hidden inputs were created
  // console.log("Row added to table:");
  // console.log("Hidden inputs in table:", document.querySelectorAll('#items-table input[type="hidden"]'));
  // console.log("Total rows in table:", document.querySelectorAll('#items-list tr').length);

  // Clear form fields
  $('#ItemName').val('').trigger('change'); // This resets Select2 and triggers the change event
  $('#item-details').html(''); // This clears the item details
  document.getElementById('Quantity').value = '';
  document.getElementById('BatchNo').value = '';
  document.getElementById('ExpiryDate').value = '';
  document.getElementById('Price').value = '';
}

function removeRow(btn) {
  btn.closest('tr').remove();
}


//function debugFormSubmission(event) {
//  // Check what data will be submitted
//  const form = event.target.form;
//  const formData = new FormData(form);
//  
//  console.log("=== FORM SUBMISSION DEBUG ===");
//  console.log("Form element:", form);
//  console.log("Hidden inputs in table:", document.querySelectorAll('#items-table input[type="hidden"]'));
//  console.log("All form elements:", form.elements);
//  
//  console.log("FormData entries:");
//  for (let [key, value] of formData.entries()) {
//    console.log(`${key}: ${value}`);
//  }
//  
//  console.log("Item names specifically:", formData.getAll('item_name'));
//  console.log("Quantities specifically:", formData.getAll('quantity'));
//  
//  // Let the form submit normally
//  return true;
//} 

// Modal Functions
function openNewMedicineModal() {
  document.getElementById('newMedicineModal').style.display = 'block';
  // Clear form when opening
  document.getElementById('newMedicineForm').reset();
  // Load medicine types from database
  loadMedicineTypes();
}

// Load medicine types from database
function loadMedicineTypes() {
  fetch('/api/medicine-types')
  .then(response => response.json())
  .then(data => {
    const typeSelect = document.getElementById('newMedicineType');
    // Clear existing options except the first one
    typeSelect.innerHTML = '<option value="">--Select Type--</option>';
    
    if (data.success && data.types) {
      data.types.forEach(typeInfo => {
        const option = document.createElement('option');
        option.value = typeInfo.type;
        option.textContent = `${typeInfo.type} (Next ID: ${typeInfo.next_id})`;
        typeSelect.appendChild(option);
      });
    } else {
      console.error('Failed to load medicine types:', data.error);
      // Fallback options if database fails
      const fallbackTypes = ['Tablet', 'Capsule', 'Syrup', 'Injection', 'Cream', 'Drops', 'Other'];
      fallbackTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });
    }
  })
  .catch(error => {
    console.error('Error loading medicine types:', error);
    // Add fallback types if request fails
    const typeSelect = document.getElementById('newMedicineType');
    const fallbackTypes = ['Tablet', 'Capsule', 'Syrup', 'Injection', 'Cream', 'Drops', 'Other'];
    fallbackTypes.forEach(type => {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      typeSelect.appendChild(option);
    });
  });
}

function closeNewMedicineModal() {
  document.getElementById('newMedicineModal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
  const modal = document.getElementById('newMedicineModal');
  if (event.target === modal) {
    closeNewMedicineModal();
  }
}

// Save new medicine
function saveNewMedicine() {
  const form = document.getElementById('newMedicineForm');
  const formData = new FormData(form);
  
  // Validate required fields
  const medicineName = formData.get('MName').trim();
  const medicineType = formData.get('Mtype').trim();
  
  if (!medicineName) {
    alert('Please enter medicine name');
    return;
  }
  
  if (!medicineType) {
    alert('Please select medicine type');
    return;
  }
  
  // Convert FormData to JSON
  const medicineData = {};
  formData.forEach((value, key) => {
    medicineData[key] = value;
  });
  
  // Send AJAX request to add medicine
  fetch('/api/add-medicine', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(medicineData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Add new medicine to dropdown
      const select = document.getElementById('ItemName');
      const option = new Option(medicineData.MName, medicineData.MName);
      select.add(option);
      
      // Select the newly added medicine
      $(select).val(medicineData.MName).trigger('change');
      
      // Close modal
      closeNewMedicineModal();
      
      // Show success message
      alert('Medicine added successfully!');
    } else {
      alert('Error adding medicine: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error adding medicine. Please try again.');
  });
}

// Bill Total Calculation Function
function calculateBillTotal() {
  const billAmount = parseFloat(document.getElementById('BillAmount').value) || 0;
  const taxAmount = parseFloat(document.getElementById('TaxAmount').value) || 0;
  const discountInBill = document.getElementById('DiscountInBill').value;
  const discAmount = parseFloat(document.getElementById('Disc_amount').value) || 0;
  
  let billTotal = 0;
  
  if (discountInBill === 'No') {
    // Bill Total = Tax Amount + Bill Amount
    billTotal = taxAmount + billAmount;
  } else if (discountInBill === 'Yes') {
    // Bill Total = Tax + Bill - Discount Amount
    billTotal = taxAmount + billAmount - discAmount;
  } else {
    // If discount option not selected, just add tax and bill
    billTotal = taxAmount + billAmount;
  }
  
  // Ensure bill total is not negative
  billTotal = Math.max(0, billTotal);
  
  // Update the bill total field
  document.getElementById('BillTotal').value = billTotal.toFixed(2);
}

// Add event listeners for automatic calculation
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to all fields that affect bill total
  const fieldsToWatch = ['BillAmount', 'TaxAmount', 'DiscountInBill', 'Disc_amount'];
  
  fieldsToWatch.forEach(fieldId => {
    const element = document.getElementById(fieldId);
    if (element) {
      element.addEventListener('input', calculateBillTotal);
      element.addEventListener('change', calculateBillTotal);
    }
  });
  
  // Initial calculation
  calculateBillTotal();
});

// Update Price Modal Functions
function openUpdatePriceModal() {
    document.getElementById('updatePriceModal').style.display = 'block';
    // Clear form when opening
    document.getElementById('updatePriceForm').reset();
    document.getElementById('currentValuesSection').style.display = 'none';
    document.getElementById('newValuesSection').style.display = 'none';
    document.getElementById('updatePriceBtn').style.display = 'none';
}

function closeUpdatePriceModal() {
    document.getElementById('updatePriceModal').style.display = 'none';
}

function loadMedicineDetails(medicineName) {
    if (medicineName) {
        // Simple approach - make a synchronous request or use the existing medicine details
        fetch(`/api/medicine-details?name=${encodeURIComponent(medicineName)}`)
        .then(response => response.json())
        .then(data => {
            if (data) {
                // Display current values
                document.getElementById('currentMRP').value = data.MRP || 'Not set';
                document.getElementById('currentPTR').value = data.PTR || 'Not set';
                document.getElementById('currentHSN').value = data.HSN || 'Not set';
                document.getElementById('currentGST').value = data.GST || 'Not set';
                
                // Store old values in hidden fields
                document.getElementById('oldMRP').value = data.MRP || '';
                document.getElementById('oldPTR').value = data.PTR || '';
                document.getElementById('oldHSN').value = data.HSN || '';
                document.getElementById('oldGST').value = data.GST || '';
                
                // Pre-fill new values with current values
                document.getElementById('newMRP').value = data.MRP || '';
                document.getElementById('newPTR').value = data.PTR || '';
                document.getElementById('newHSN').value = data.HSN || '';
                document.getElementById('newGST').value = data.GST || '';
                
                // Show sections and update button
                document.getElementById('currentValuesSection').style.display = 'block';
                document.getElementById('newValuesSection').style.display = 'block';
                document.getElementById('updatePriceBtn').style.display = 'inline-block';
            }
        })
        .catch(error => {
            console.error('Error loading medicine details:', error);
            alert('Error loading medicine details. Please try again.');
        });
    } else {
        document.getElementById('currentValuesSection').style.display = 'none';
        document.getElementById('newValuesSection').style.display = 'none';
        document.getElementById('updatePriceBtn').style.display = 'none';
    }
}

function submitPriceUpdate() {
    const form = document.getElementById('updatePriceForm');
    const medicineName = document.getElementById('updateMedicineName').value;
    const newMRP = document.getElementById('newMRP').value;
    
    if (!medicineName) {
        alert('Please select a medicine');
        return;
    }
    
    if (!newMRP || parseFloat(newMRP) <= 0) {
        alert('Please enter a valid new MRP');
        return;
    }
    
    // Confirm the update
    if (confirm(`Are you sure you want to update the price for ${medicineName}?`)) {
        form.submit();
    }
}

// Update the window click handler to include the new modal
window.onclick = function(event) {
    const newMedicineModal = document.getElementById('newMedicineModal');
    const updatePriceModal = document.getElementById('updatePriceModal');
    
    if (event.target === newMedicineModal) {
        closeNewMedicineModal();
    } else if (event.target === updatePriceModal) {
        closeUpdatePriceModal();
    }
}
</script>



{% endblock %}